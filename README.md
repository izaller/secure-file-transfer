# secure file transfer
project completed in fulfillment of requirements for Aquincum Institute of Technology's Applied Cryptography course.
Our implementation uses a secure login protocol, session keys established through using a Diffie-Hellman exchange and 
HKDF, message sequence numbers and authenticated encryption (AES in GCM mode) to create a secure file transfer application.

## required package installation
Before use, run the following commands from the terminal
```
pip install pyDH
pip install pycryptodome
```



## running the program

use the following commands in separate terminal windows:
```
python3 network.py -p './network/' -a 'USM' --clean
python3 server.py
python3 client.py
```

## network.py
Sets up the network in a folder called "network". Running the network.py command
highlighted in the box above will create folders based on the -a
parameters. The folders correspond to addresses of users on the network.
'U' and 'S' stand for 'user' and 'server'. 'M' stands for 'Mallory'. 
## server.py

The server only accepts one user logged on at a time. Commands or login requests from
users other than the currently logged on user will not be accepted.

If no messages from the logged on user are received for 1 minute, forces the user
to log out. (note: time frame is short for demonstration purposes)

Message format to server:```[nonce | header | message | tag]``` 

## client.py
Collects user input message and sends to server using netinterface.

Message format to server:```[nonce | header | message | tag]```

**byte breakdown:**
```
  nonce (16 bytes) 
+ header (5 bytes -- 1 byte sender addr, 4 bytes message sequence number)
+ message (cmd = 1 byte + optional arg)
+ tag (16 bytes)
```

## data structures
### session
Stores two values: partner address and AES key

### serverif
Server interface. Stores its own address ('S'), the network path ('./network'), a session (defaults to None), a working directory, and a root.
When a user successfully logs in, a session is created and stored. Session stores partner's address (user address)
and shared AES key. After login both the working directory and the root are set to './server/U/'

### user
Client-side object. Created at login. Stores user's own address and a session.
Session contains partner's address (server) and shared AES key.

## Login

Login supported for all users in the namespace A-Z who are specified in the network setup.
Each user's password hash is stored on the server. The password is "password" + the user's address (eg. "passwordU")

Login uses the package pyDH for Diffie-Hellman exchange to generate a shared secret and HKDF (with salt generated by the user)
to generate an AES key which can be used as the session key.

Current message exchange:

> user to server: **[address | login request | password | g^x mod p | salt]**

Login request signified by keycode '1' (see commands dictionary in client_ops.py). Password is hard-coded as *password* for all users. If user submits valid password, server returns response '1'. Otherwise the 
server returns '0'.

> server to user: **[correct password | g^y mod p | sigS(addr | g^x mod p | S | g^y mod p)]**

*Note: if password is incorrect, only **[incorrect password]** flag is sent* ('0') *and login process terminates*

After these messages check out, users compute the shared AES key using HKDF and store it in their session objects. Once a user has successfully logged in, they are given a list of commands they can use.

[pyDH docs](https://pypi.org/project/pyDH/) | [HKDF docs](https://pycryptodome.readthedocs.io/en/latest/src/protocol/kdf.html#hkdf)


### login demo
In two separate terminal tabs, execute the following commands
to start the network and the server.
```
python3 network.py -p './network/' -a 'USM' --clean
python3 server.py
```
Open another tab and run ```python3 client.py```.
When prompted, enter 'U' for user address and 'password' for the password.
You should now be logged in.

Finally, open a fourth tab and once again run ```python3 client.py```.
When prompted, enter 'M' for user address and any password.
You should receive the following message: *The server is currently unavailable. Please try again later.*

## Commands

### MKD
```MKD [dirname]```
make directory with name dirname on the server

### RMD
```RMD [dirname]```
 remove directory with name dirname from the server
 If directory is nonempty, also deletes all files within the directory from the server

### GWD
 ```GWD``` print the name of the current working directory

### CWD
``` CWD [dirname]``` change the current directory to the directory named dirname

*dirname* argument must take the form './server/U/...' where U is the logged in user's address -- the dirname must start from the root
This ensures a malicious user cannot login to the server and then change the working directory to another user's folder.

### LST
```LST [dirname]``` list the contents of the directory on the server named dirname

*dirname* must be accessible from current wd. To list contents of current wd, use dirname = '.'

### UPL
```UPL [path to file]``` upload the file located at the input file path to the current working directory on the server

*path to file* must be the absolute path (ex. '/Users/isabelzaller/Desktop/crypto/secure-file-transfer/netsim/')
or the relative path from the netsim folder (ex. './upload-me.txt')
## DNL
 ```DNL [filename]``` download the file named filename from the current directory

### RMF
``` RMF [filename]``` delete the file named filename from the current directory

### LOGOUT
```LOGOUT``` log off from the server
